# --- CASCATA: GUIA DE INSTALAÇÃO CLÍNICA ---

# 1. Preparação do Ambiente
  cd ~
  git clone https://github.com/supermetanet-png/cascata.git
  cd ~/cascata

# 2. Criação da Estrutura de Pastas e Sanitização
# Removemos possíveis pastas criadas indevidamente pelo Docker em tentativas falhas
rm -rf nginx
rm -rf database
rm -rf backend/migrations
mkdir -p nginx
mkdir -p database
mkdir -p backend/migrations
mkdir -p storage
mkdir -p temp_uploads

# 3. Renomeação de Arquivos de Infraestrutura
mv .env.txt .env
mv .dockerignore.txt .dockerignore
mv nginx.conf.txt nginx/nginx.conf
mv database/init.sql.txt database/init.sql
mv backend/Dockerfile.txt backend/Dockerfile
mv frontend/Dockerfile.txt frontend/Dockerfile
mv frontend/nginx.conf.txt frontend/nginx.conf
mv nginx-controller/Dockerfile.txt nginx-controller/Dockerfile

# 4. Renomeação das Migrações (Passo Crítico para o Migration Runner)
mv backend/migrations/001_init.sql.txt backend/migrations/001_init.sql
mv backend/migrations/002_rate_limits.sql.txt backend/migrations/002_rate_limits.sql
mv backend/migrations/003_n8n_support.sql.txt backend/migrations/003_n8n_support.sql
mv backend/migrations/004_rate_limit_v2.sql.txt backend/migrations/004_rate_limit_v2.sql
mv backend/migrations/005_ai_memory.sql.txt backend/migrations/005_ai_memory.sql
mv backend/migrations/006_asset_history.sql.txt backend/migrations/006_asset_history.sql
mv backend/migrations/007_ai_sessions.sql.txt backend/migrations/007_ai_sessions.sql
mv backend/migrations/008_auth_hardening.sql.txt backend/migrations/008_auth_hardening.sql
mv backend/migrations/009_immutable_logs.sql.txt backend/migrations/009_immutable_logs.sql
mv backend/migrations/010_auth_confirmation.sql.txt backend/migrations/010_auth_confirmation.sql
mv backend/migrations/011_webhook_filters.sql.txt backend/migrations/011_webhook_filters.sql
mv backend/migrations/012_webhook_reliability.sql.txt backend/migrations/012_webhook_reliability.sql
mv backend/migrations/013_auth_helpers.sql.txt backend/migrations/013_auth_helpers.sql


# 6. Deploy e Build
docker compose up -d --build

# 7. Verificação de Saúde
# docker compose ps
# docker compose logs -f cascata-nginx